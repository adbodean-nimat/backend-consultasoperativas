var config = require('./dbconfig.js');
const sql = require('mssql');

async function getLPPYRStock(){
  try {
    let pool = await sql.connect(config);
    let infoLP = await pool.request().query("DECLARE @DeposANoConsiderar TABLE(Cod_Depos NUMERIC, Nombre_Deposito VARCHAR(40)) INSERT INTO @DeposANoConsiderar VALUES(10, 'CONT.ALQUILADOS'), (702, 'SCRAP PROVEEDORES'), (901, 'NO APTOS PARA VENTA'), (905, 'EN TRANSITO A REPARA'), (910, 'RECPECION'), (930, 'DEVOL. A PROVEEDORES'), (950, 'SALON NO RESERVABLE'), (973, 'STOCK RESERVADO') DECLARE @NP_a_considerar TABLE (COD_COMP VARCHAR(3), NOMB_COMP VARCHAR(30)) INSERT INTO @NP_a_considerar VALUES ('NPC', 'Nota pedido contado'), ('NPG', 'Nota pedido gerencial'), ('NPT', 'Nota pedido cuanta corriente'), ('PEA', 'Pedido entrega acopio') DECLARE @Lista_precio_1 TABLE (ARTS_ARTICULO_EMP VARCHAR(30) ,ARTS_NOMBRE VARCHAR(70) ,ARPV_ARTICULO INT ,ARPV_LISTA_PRECVTA INT ,ARPV_PRECIO_VTA DECIMAL(14,2) ,ARPV_MONEDA VARCHAR(3) ,MáxDeCOTI_FECHA DATETIME ,CIMP_TASA DECIMAL (7,4)) INSERT INTO @Lista_precio_1 SELECT dbo.STOC_ARTS.ARTS_ARTICULO_EMP ,dbo.STOC_ARTS.ARTS_NOMBRE ,dbo.VENT_ARPV.ARPV_ARTICULO ,dbo.VENT_ARPV.ARPV_LISTA_PRECVTA ,dbo.VENT_ARPV.ARPV_PRECIO_VTA ,dbo.VENT_ARPV.ARPV_MONEDA ,Max(dbo.SIST_COTI.COTI_FECHA) AS MáxDeCOTI_FECHA ,dbo.SIST_CIMP.CIMP_TASA FROM dbo.STOC_ARTS WITH (NOLOCK) INNER JOIN (((dbo.VENT_ARPV WITH (NOLOCK) LEFT JOIN dbo.SIST_COTI WITH (NOLOCK) ON dbo.VENT_ARPV.ARPV_MONEDA = dbo.SIST_COTI.COTI_MONEDA1) INNER JOIN dbo.VENT_ARVI WITH (NOLOCK) ON dbo.VENT_ARPV.ARPV_ARTICULO = dbo.VENT_ARVI.ARVI_ARTICULO) INNER JOIN dbo.SIST_CIMP WITH (NOLOCK) ON (dbo.VENT_ARVI.ARVI_CATEGORIA_IMP = dbo.SIST_CIMP.CIMP_CATEGORIA_IMP) AND (dbo.VENT_ARVI.ARVI_IMPUESTO = dbo.SIST_CIMP.CIMP_IMPUESTO)) ON dbo.STOC_ARTS.ARTS_ARTICULO = dbo.VENT_ARPV.ARPV_ARTICULO GROUP BY dbo.STOC_ARTS.ARTS_ARTICULO_EMP ,dbo.STOC_ARTS.ARTS_NOMBRE ,dbo.VENT_ARPV.ARPV_ARTICULO ,dbo.VENT_ARPV.ARPV_LISTA_PRECVTA ,dbo.VENT_ARPV.ARPV_PRECIO_VTA ,dbo.VENT_ARPV.ARPV_MONEDA ,dbo.SIST_CIMP.CIMP_TASA HAVING (((dbo.VENT_ARPV.ARPV_LISTA_PRECVTA)=1)) ORDER BY Max(dbo.SIST_COTI.COTI_FECHA) DECLARE @Lista_precio_1_2 TABLE (ARTS_ARTICULO_EMP VARCHAR(30) ,ARTS_NOMBRE VARCHAR(70) ,ARPV_ARTICULO INT ,ARPV_LISTA_PRECVTA INT ,ARPV_PRECIO_VTA DECIMAL(14,2) ,ARPV_MONEDA VARCHAR(3) ,COTI_COTIZACION DECIMAL(14,2) ,CIMP_TASA DECIMAL (7,2) ,PRECIO_BASE_PESOS DECIMAL (14,2) ,Pre_Lista_con_IVA_L1 DECIMAL (14,2) ,Pre_Cdo_con_IVA_L1 DECIMAL (14,2) ) INSERT INTO @Lista_precio_1_2 SELECT [@Lista_precio_1].ARTS_ARTICULO_EMP ,[@Lista_precio_1].ARTS_NOMBRE ,[@Lista_precio_1].ARPV_ARTICULO ,[@Lista_precio_1].ARPV_LISTA_PRECVTA ,[@Lista_precio_1].ARPV_PRECIO_VTA ,[@Lista_precio_1].ARPV_MONEDA ,dbo.SIST_COTI.COTI_COTIZACION ,[@Lista_precio_1].CIMP_TASA ,(CASE WHEN COTI_COTIZACION = [COTI_COTIZACION] THEN ([ARPV_PRECIO_VTA]*[COTI_COTIZACION]) ELSE [ARPV_PRECIO_VTA] END) AS [PRECIO_BASE_PESOS] ,Round((CASE WHEN COTI_COTIZACION = [COTI_COTIZACION] THEN ([ARPV_PRECIO_VTA]*[COTI_COTIZACION]) ELSE [ARPV_PRECIO_VTA] END)*(1+[CIMP_TASA]/100), 2) AS [Pre_Lista_con_IVA_L1] ,Round((CASE WHEN COTI_COTIZACION = [COTI_COTIZACION] THEN ([ARPV_PRECIO_VTA]*[COTI_COTIZACION]) ELSE [ARPV_PRECIO_VTA] END)*0.8*(1+[CIMP_TASA]/100), 2) AS [Pre_Cdo_con_IVA_L1] FROM @Lista_precio_1 LEFT JOIN dbo.SIST_COTI WITH (NOLOCK) ON ([@Lista_precio_1].MáxDeCOTI_FECHA = dbo.SIST_COTI.COTI_FECHA) AND ([@Lista_precio_1].ARPV_MONEDA = dbo.SIST_COTI.COTI_MONEDA1) DECLARE @Clasif_a_considerar_pyr TABLE (Clasif_2 VARCHAR(10), Nombre_Clasif_2 VARCHAR(30)) INSERT INTO @Clasif_a_considerar_pyr VALUES ('0004','PISOS Y REVESTIMIENTOS'), ('0006','GRIF.1Y2 AGUAS') DECLARE @NP_Pendientes_entrega_1 TABLE (NPCA_FECHA_EMI DATETIME ,NPCA_DIVISION_NPCA SMALLINT ,NPCA_TIPO_NPCA VARCHAR(3) ,NPCA_NUMERO_NPCA DECIMAL(10,0) ,ARTS_ARTICULO_EMP VARCHAR(30) ,ARTS_NOMBRE VARCHAR(70) ,NPDE_UNIMED VARCHAR(3) ,NPDE_CANT_PEDIDA DECIMAL(14,0) ,NPDE_CANT_ENTREG DECIMAL(14,0) ,NPDE_MOTIVO_CANC VARCHAR(3) ,Uni_Pte_Entr_NP DECIMAL(14,0) ,ARTS_FACTOR_HOMSTO DECIMAL(20,12) ) INSERT INTO @NP_Pendientes_entrega_1 SELECT dbo.VENT_NPCA.NPCA_FECHA_EMI ,dbo.VENT_NPCA.NPCA_DIVISION_NPCA ,dbo.VENT_NPCA.NPCA_TIPO_NPCA ,dbo.VENT_NPCA.NPCA_NUMERO_NPCA ,dbo.STOC_ARTS.ARTS_ARTICULO_EMP ,dbo.STOC_ARTS.ARTS_NOMBRE ,dbo.VENT_NPDE.NPDE_UNIMED ,dbo.VENT_NPDE.NPDE_CANT_PEDIDA ,dbo.VENT_NPDE.NPDE_CANT_ENTREG ,dbo.VENT_NPDE.NPDE_MOTIVO_CANC ,[NPDE_CANT_PEDIDA]-[NPDE_CANT_ENTREG] AS [Uni_Pte_Entr_NP] ,dbo.STOC_ARTS.ARTS_FACTOR_HOMSTO FROM @NP_a_considerar INNER JOIN (((dbo.VENT_NPCA WITH (NOLOCK) INNER JOIN dbo.VENT_NPDE WITH (NOLOCK) ON (dbo.VENT_NPCA.NPCA_DIVISION_NPCA = dbo.VENT_NPDE.NPDE_DIVISION_NPCA) AND (dbo.VENT_NPCA.NPCA_TIPO_NPCA = dbo.VENT_NPDE.NPDE_TIPO_NPCA) AND (dbo.VENT_NPCA.NPCA_NUMERO_NPCA = dbo.VENT_NPDE.NPDE_NUMERO_NPCA)) INNER JOIN dbo.STOC_ARTS WITH (NOLOCK) ON dbo.VENT_NPDE.NPDE_ARTICULO = dbo.STOC_ARTS.ARTS_ARTICULO) INNER JOIN @Clasif_a_considerar_pyr ON dbo.STOC_ARTS.ARTS_CLASIF_2 = [@Clasif_a_considerar_pyr].Clasif_2) ON [@NP_a_considerar].[COD_COMP] = dbo.VENT_NPCA.NPCA_TIPO_NPCA WHERE (((dbo.VENT_NPDE.NPDE_MOTIVO_CANC) Is Null)) DECLARE @NP_Pendientes_entrega_2 TABLE (NPCA_FECHA_EMI DATETIME ,NPCA_DIVISION_NPCA SMALLINT ,NPCA_TIPO_NPCA VARCHAR(3) ,NPCA_NUMERO_NPCA DECIMAL(10,0) ,ARTS_ARTICULO_EMP VARCHAR(30) ,ARTS_NOMBRE VARCHAR(70) ,NPDE_UNIMED VARCHAR(3) ,NPDE_CANT_PEDIDA DECIMAL(14,0) ,NPDE_CANT_ENTREG DECIMAL(14,0) ,NPDE_MOTIVO_CANC VARCHAR(3) ,Uni_Pte_Entr_NP DECIMAL(14,0) ,ARTS_FACTOR_HOMSTO DECIMAL(20,12) ,M2_Pte_Entr_NP DECIMAL(14,2)) INSERT INTO @NP_Pendientes_entrega_2 SELECT [@NP_Pendientes_entrega_1].NPCA_FECHA_EMI ,[@NP_Pendientes_entrega_1].NPCA_DIVISION_NPCA ,[@NP_Pendientes_entrega_1].NPCA_TIPO_NPCA ,[@NP_Pendientes_entrega_1].NPCA_NUMERO_NPCA ,[@NP_Pendientes_entrega_1].ARTS_ARTICULO_EMP ,[@NP_Pendientes_entrega_1].ARTS_NOMBRE ,[@NP_Pendientes_entrega_1].NPDE_UNIMED ,[@NP_Pendientes_entrega_1].NPDE_CANT_PEDIDA ,[@NP_Pendientes_entrega_1].NPDE_CANT_ENTREG ,[@NP_Pendientes_entrega_1].NPDE_MOTIVO_CANC ,[@NP_Pendientes_entrega_1].[Uni_Pte_Entr_NP] ,[@NP_Pendientes_entrega_1].ARTS_FACTOR_HOMSTO ,IIf([ARTS_FACTOR_HOMSTO]=0,0,Round([Uni_Pte_Entr_NP]/[ARTS_FACTOR_HOMSTO],3)) AS [M2_Pte_Entr_NP] FROM @NP_Pendientes_entrega_1 WHERE ((([@NP_Pendientes_entrega_1].[Uni_Pte_Entr_NP])>0)) DECLARE @NP_Pendientes_entrega_3 TABLE (ARTS_ARTICULO_EMP VARCHAR(30), ARTS_NOMBRE VARCHAR(70), Uni_Pte_Entr_NP DECIMAL(14,0), M2_Pte_Entr_NP DECIMAL(14,2)) INSERT INTO @NP_Pendientes_entrega_3 SELECT DISTINCT [@NP_Pendientes_entrega_2].ARTS_ARTICULO_EMP ,[@NP_Pendientes_entrega_2].ARTS_NOMBRE ,Sum([@NP_Pendientes_entrega_2].[Uni_Pte_Entr_NP]) AS [Uni_Pte_Entr_NP] ,Sum([@NP_Pendientes_entrega_2].[M2_Pte_Entr_NP]) AS [M2_Pte_Entr_NP] FROM @NP_Pendientes_entrega_2 GROUP BY [@NP_Pendientes_entrega_2].ARTS_ARTICULO_EMP ,[@NP_Pendientes_entrega_2].ARTS_NOMBRE DECLARE @ListaPrecios_PYR_completa TABLE (ARTS_CLASIF_3 VARCHAR(10) ,CA03_NOMBRE VARCHAR(30) ,ARTS_CLASIF_5 VARCHAR(10) ,CA05_NOMBRE VARCHAR(30) ,ARTS_ARTICULO_EMP VARCHAR(30) ,ARTS_NOMBRE VARCHAR(70) ,Pre_Cdo_con_IVA_L1 DECIMAL(14,2) ,Pre_Cdo_con_IVA_M2 DECIMAL(14,2) ,M2_Caja DECIMAL(14,3) ,CA04_CLASIF_4 VARCHAR(10) ,CA04_NOMBRE VARCHAR(30) ,ARTS_CLASIF_10 VARCHAR(10) ,CA10_NOMBRE VARCHAR(30) ) INSERT INTO @ListaPrecios_PYR_completa SELECT dbo.STOC_ARTS.ARTS_CLASIF_3 ,dbo.STOC_CA03.CA03_NOMBRE ,dbo.STOC_ARTS.ARTS_CLASIF_5 ,dbo.STOC_CA05.CA05_NOMBRE ,dbo.STOC_ARTS.ARTS_ARTICULO_EMP ,dbo.STOC_ARTS.ARTS_NOMBRE ,[@Lista_precio_1_2].[Pre_Cdo_con_IVA_L1] ,Round([@Lista_precio_1_2].[Pre_Cdo_con_IVA_L1]*dbo.STOC_ARTS.[ARTS_FACTOR_HOMSTO],2) AS [Pre_Cdo_con_IVA_M2] ,Round(1/NULLIF([ARTS_FACTOR_HOMSTO],0),3) AS [M2_Caja] ,dbo.STOC_CA04.CA04_CLASIF_4 ,dbo.STOC_CA04.CA04_NOMBRE ,dbo.STOC_ARTS.ARTS_CLASIF_10 ,dbo.STOC_CA10.CA10_NOMBRE FROM ((@Clasif_a_considerar_pyr INNER JOIN ((((@Lista_precio_1_2 INNER JOIN dbo.STOC_ARTS WITH (NOLOCK) ON [@Lista_precio_1_2].ARPV_ARTICULO = dbo.STOC_ARTS.ARTS_ARTICULO) INNER JOIN dbo.STOC_CA02 WITH (NOLOCK) ON dbo.STOC_ARTS.ARTS_CLASIF_2 = dbo.STOC_CA02.CA02_CLASIF_2) INNER JOIN dbo.STOC_CA03 WITH (NOLOCK) ON dbo.STOC_ARTS.ARTS_CLASIF_3 = dbo.STOC_CA03.CA03_CLASIF_3) LEFT JOIN dbo.STOC_CA05 WITH (NOLOCK) ON dbo.STOC_ARTS.ARTS_CLASIF_5 = dbo.STOC_CA05.CA05_CLASIF_5) ON [@Clasif_a_considerar_pyr].[Clasif_2] = dbo.STOC_ARTS.ARTS_CLASIF_2) INNER JOIN dbo.STOC_CA04 WITH (NOLOCK) ON dbo.STOC_ARTS.ARTS_CLASIF_4 = dbo.STOC_CA04.CA04_CLASIF_4) LEFT JOIN dbo.STOC_CA10 WITH (NOLOCK) ON dbo.STOC_ARTS.ARTS_CLASIF_10 = dbo.STOC_CA10.CA10_CLASIF_10 WHERE (((dbo.STOC_ARTS.ARTS_CLASIF_2)='0004')) ORDER BY dbo.STOC_CA03.CA03_NOMBRE ,dbo.STOC_CA05.CA05_NOMBRE ,Round([Pre_Cdo_con_IVA_L1]*[ARTS_FACTOR_HOMSTO],2) DESC DECLARE @Stock_1 TABLE (ARTS_ARTICULO INT ,Cód_Art VARCHAR(30) ,Nombre_Art VARCHAR(70) ,Stock_Uni DECIMAL(14,4) ,Uni_HS VARCHAR(3) ,ARTS_FACTOR_HOMSTO DECIMAL(20,12) ,ARTS_CLASIF_1 VARCHAR(10) ,ARTS_CLASIF_2 VARCHAR(10) ,ARTS_CLASIF_3 VARCHAR(10) ,ARTS_CLASIF_4 VARCHAR(10) ,ARTS_CLASIF_5 VARCHAR(10) ,ARTS_CLASIF_6 VARCHAR(10) ,ARTS_CLASIF_7 VARCHAR(10) ,ARTS_CLASIF_8 VARCHAR(10) ) INSERT INTO @Stock_1 SELECT dbo.STOC_ARTS.ARTS_ARTICULO ,dbo.STOC_ARTS.ARTS_ARTICULO_EMP AS [Cód_Art] ,dbo.STOC_ARTS.ARTS_NOMBRE AS [Nombre_Art] ,Sum(dbo.STOC_SDPP.SDPP_STOCK_ACT) AS [Stock_Uni] ,dbo.STOC_ARTS.ARTS_UNIMED_HOMSTO AS [Uni_HS] ,dbo.STOC_ARTS.ARTS_FACTOR_HOMSTO ,dbo.STOC_ARTS.ARTS_CLASIF_1 ,dbo.STOC_ARTS.ARTS_CLASIF_2 ,dbo.STOC_ARTS.ARTS_CLASIF_3 ,dbo.STOC_ARTS.ARTS_CLASIF_4 ,dbo.STOC_ARTS.ARTS_CLASIF_5 ,dbo.STOC_ARTS.ARTS_CLASIF_6 ,dbo.STOC_ARTS.ARTS_CLASIF_7 ,dbo.STOC_ARTS.ARTS_CLASIF_8 FROM ((@Clasif_a_considerar_pyr INNER JOIN dbo.STOC_ARTS WITH (NOLOCK) ON [@Clasif_a_considerar_pyr].[Clasif_2] = dbo.STOC_ARTS.ARTS_CLASIF_2) LEFT JOIN dbo.STOC_SDPP WITH (NOLOCK) ON dbo.STOC_ARTS.ARTS_ARTICULO = dbo.STOC_SDPP.SDPP_ARTICULO) LEFT JOIN @DeposANoConsiderar ON dbo.STOC_SDPP.SDPP_DEPOSITO = [@DeposANoConsiderar].[Cod_Depos] GROUP BY dbo.STOC_ARTS.ARTS_ARTICULO ,dbo.STOC_ARTS.ARTS_ARTICULO_EMP ,dbo.STOC_ARTS.ARTS_NOMBRE ,dbo.STOC_ARTS.ARTS_UNIMED_HOMSTO ,dbo.STOC_ARTS.ARTS_FACTOR_HOMSTO ,dbo.STOC_ARTS.ARTS_CLASIF_1 ,dbo.STOC_ARTS.ARTS_CLASIF_2 ,dbo.STOC_ARTS.ARTS_CLASIF_3 ,dbo.STOC_ARTS.ARTS_CLASIF_4 ,dbo.STOC_ARTS.ARTS_CLASIF_5 ,dbo.STOC_ARTS.ARTS_CLASIF_6 ,dbo.STOC_ARTS.ARTS_CLASIF_7 ,dbo.STOC_ARTS.ARTS_CLASIF_8 ,[@DeposANoConsiderar].[Nombre_Deposito] HAVING ((([@DeposANoConsiderar].[Nombre_Deposito]) Is Null)) DECLARE @Stock_2_positivo TABLE (ARTS_ARTICULO INT ,Cód_Art VARCHAR(30) ,Nombre_Art VARCHAR(70) ,Stock_Uni DECIMAL(14,0) ,Uni_HS VARCHAR(3) ,ARTS_FACTOR_HOMSTO DECIMAL(20,12) ,Stock_M2 DECIMAL(14,2) ,M2_Caja DECIMAL(14,3) ,ARTS_CLASIF_2 VARCHAR(10) ,AGRUP_A_MAYOR VARCHAR(30) ,ARTS_CLASIF_3 VARCHAR(10) ,AGRUP_B_MEDIA VARCHAR(30) ,ARTS_CLASIF_4 VARCHAR(10) ,AGRUP_C_MENOR VARCHAR(30) ,ARTS_CLASIF_5 VARCHAR(10) ,AGRUP_D_MINI VARCHAR(30) ,ARTS_CLASIF_6 VARCHAR(10) ,AGRUP_E_MARCA VARCHAR(30) ,STOCK_Y_PRODUCCION VARCHAR(30) ) INSERT INTO @Stock_2_positivo SELECT [@Stock_1].[ARTS_ARTICULO] ,[@Stock_1].[Cód_Art] ,[@Stock_1].[Nombre_Art] ,[@Stock_1].[Stock_Uni] ,[@Stock_1].[Uni_HS] ,[@Stock_1].[ARTS_FACTOR_HOMSTO] ,(CASE WHEN Stock_Uni = [Stock_Uni] THEN (Round([Stock_Uni]/NULLIF([ARTS_FACTOR_HOMSTO],0),2)) ELSE 0 END) AS [Stock_M2] ,Round(1/NULLIF([ARTS_FACTOR_HOMSTO],0),3) AS [M2_Caja] ,dbo.STOC_CA02.CA02_CLASIF_2 ,dbo.STOC_CA02.CA02_NOMBRE AS [AGRUP_A_MAYOR] ,dbo.STOC_CA03.CA03_CLASIF_3 ,dbo.STOC_CA03.CA03_NOMBRE AS [AGRUP_B_MEDIA] ,dbo.STOC_CA04.CA04_CLASIF_4 ,dbo.STOC_CA04.CA04_NOMBRE AS [AGRUP_C_MENOR] ,dbo.STOC_CA05.CA05_CLASIF_5 ,dbo.STOC_CA05.CA05_NOMBRE AS [AGRUP_D_MINI] ,dbo.STOC_CA06.CA06_CLASIF_6 ,dbo.STOC_CA06.CA06_NOMBRE AS [AGRUP_E_MARCA] ,dbo.STOC_CA08.CA08_NOMBRE AS [STOCK_Y_PRODUCCION] FROM (((((@Stock_1 INNER JOIN dbo.STOC_CA02 WITH (NOLOCK) ON [@Stock_1].ARTS_CLASIF_2 = dbo.STOC_CA02.CA02_CLASIF_2) INNER JOIN dbo.STOC_CA03 WITH (NOLOCK) ON [@Stock_1].ARTS_CLASIF_3 = dbo.STOC_CA03.CA03_CLASIF_3) INNER JOIN dbo.STOC_CA04 WITH (NOLOCK) ON [@Stock_1].ARTS_CLASIF_4 = dbo.STOC_CA04.CA04_CLASIF_4) INNER JOIN dbo.STOC_CA05 WITH (NOLOCK) ON [@Stock_1].ARTS_CLASIF_5 = dbo.STOC_CA05.CA05_CLASIF_5) INNER JOIN dbo.STOC_CA06 WITH (NOLOCK) ON [@Stock_1].ARTS_CLASIF_6 = dbo.STOC_CA06.CA06_CLASIF_6) INNER JOIN dbo.STOC_CA08 WITH (NOLOCK) ON [@Stock_1].ARTS_CLASIF_8 = dbo.STOC_CA08.CA08_CLASIF_8 WHERE ((([@Stock_1].[Stock_Uni])>0)) DECLARE @ListaPrecio_PYR_Stock_positivo TABLE (CA03_NOMBRE VARCHAR(30) ,ARTS_ARTICULO INT ,ARTS_ARTICULO_EMP VARCHAR(30) ,ARTS_NOMBRE VARCHAR(70) ,Pre_Cdo_con_IVA_L1 DECIMAL(14,2) ,Pre_Cdo_con_IVA_M2 DECIMAL(14,2) ,M2_Caja DECIMAL(14,3) ,Stock_Uni DECIMAL(14,0) ,Stock_M2 DECIMAL(14,2) ,ARTS_CLASIF_10 VARCHAR(10) ,CA10_NOMBRE VARCHAR(30) ,CA05_NOMBRE VARCHAR(30) ,CA04_CLASIF_4 VARCHAR(10) ,CA04_NOMBRE VARCHAR(30)) INSERT INTO @ListaPrecio_PYR_Stock_positivo SELECT [@ListaPrecios_PYR_completa].CA03_NOMBRE ,[@Stock_2_positivo].ARTS_ARTICULO ,[@ListaPrecios_PYR_completa].ARTS_ARTICULO_EMP ,[@ListaPrecios_PYR_completa].ARTS_NOMBRE ,[@ListaPrecios_PYR_completa].[Pre_Cdo_con_IVA_L1] ,[@ListaPrecios_PYR_completa].[Pre_Cdo_con_IVA_M2] ,[@ListaPrecios_PYR_completa].[M2_Caja] ,[@Stock_2_positivo].[Stock_Uni] ,[@Stock_2_positivo].[Stock_M2] ,[@ListaPrecios_PYR_completa].ARTS_CLASIF_10 ,[@ListaPrecios_PYR_completa].CA10_NOMBRE ,[@ListaPrecios_PYR_completa].CA05_NOMBRE ,[@ListaPrecios_PYR_completa].CA04_CLASIF_4 ,[@ListaPrecios_PYR_completa].CA04_NOMBRE FROM @ListaPrecios_PYR_completa INNER JOIN @Stock_2_positivo ON [@ListaPrecios_PYR_completa].ARTS_ARTICULO_EMP = [@Stock_2_positivo].[Cód_Art] ORDER BY [@ListaPrecios_PYR_completa].CA03_NOMBRE ,[@ListaPrecios_PYR_completa].[Pre_Cdo_con_IVA_M2] DESC DECLARE @LP_Precios_PYR_con_stock TABLE( CA03_NOMBRE VARCHAR(30) ,Tipología VARCHAR(30) ,ARTS_ARTICULO_EMP VARCHAR(30) ,ARTS_NOMBRE VARCHAR(70) ,Pre_Cdo_con_IVA_L1 DECIMAL(14,2) ,Pre_Cdo_con_IVA_M2 DECIMAL(14,2) ,RAC_M2 DECIMAL(14,2) ,Stock_Uni DECIMAL(14,0) ,Stock_M2 DECIMAL(14,2) ,M2_Pte_Entr_NP DECIMAL(14,2) ,M2_Disp_Habil_Vta DECIMAL(14,2) ,Bloqueado_Vtas VARCHAR(30) ,M2_Bloqueado_Vta DECIMAL(14,0) ,Uso VARCHAR(30) ) INSERT INTO @LP_Precios_PYR_con_stock SELECT [@ListaPrecio_PYR_Stock_positivo].CA03_NOMBRE ,IIf([ARTS_CLASIF_10]='0002',NULL,IIf([ARTS_CLASIF_10]='0001',NULL,[CA10_NOMBRE])) AS Tipología ,[@ListaPrecio_PYR_Stock_positivo].ARTS_ARTICULO_EMP ,[@ListaPrecio_PYR_Stock_positivo].ARTS_NOMBRE ,[@ListaPrecio_PYR_Stock_positivo].[Pre_Cdo_con_IVA_L1] ,[@ListaPrecio_PYR_Stock_positivo].[Pre_Cdo_con_IVA_M2] ,[@ListaPrecio_PYR_Stock_positivo].[M2_Caja] AS [RAC_M2] ,[@ListaPrecio_PYR_Stock_positivo].[Stock_Uni] ,[@ListaPrecio_PYR_Stock_positivo].[Stock_M2] ,[@NP_Pendientes_entrega_3].[M2_Pte_Entr_NP] ,(CASE WHEN [ARVE_BLOQUEO_VENTA] = 0 THEN ( CASE WHEN [Stock_M2]-(CASE WHEN M2_Pte_Entr_NP = [M2_Pte_Entr_NP] THEN [M2_Pte_Entr_NP] ELSE 0 END) < 0 THEN 0 ELSE [Stock_M2]-(CASE WHEN [M2_Pte_Entr_NP] = [M2_Pte_Entr_NP] THEN [M2_Pte_Entr_NP] ELSE 0 END) END ) ELSE 0 END ) AS [M2_Disp_Habil_Vta] ,IIf([ARVE_BLOQUEO_VENTA]=0,' no',' SI') AS [Bloqueado_Vtas] ,(CASE WHEN [ARVE_BLOQUEO_VENTA] = 1 THEN ( CASE WHEN [Stock_M2]-(CASE WHEN M2_Pte_Entr_NP = [M2_Pte_Entr_NP] THEN [M2_Pte_Entr_NP] ELSE 0 END) < 0 THEN 0 ELSE [Stock_M2]-(CASE WHEN [M2_Pte_Entr_NP] = [M2_Pte_Entr_NP] THEN [M2_Pte_Entr_NP] ELSE 0 END) END ) ELSE 0 END ) AS [M2_Bloqueado_Vta] ,[@ListaPrecio_PYR_Stock_positivo].CA04_NOMBRE AS Uso FROM (@ListaPrecio_PYR_Stock_positivo LEFT JOIN @NP_Pendientes_entrega_3 ON [@ListaPrecio_PYR_Stock_positivo].ARTS_ARTICULO_EMP = [@NP_Pendientes_entrega_3].ARTS_ARTICULO_EMP) INNER JOIN dbo.STOC_ARVE WITH (NOLOCK) ON [@ListaPrecio_PYR_Stock_positivo].ARTS_ARTICULO = dbo.STOC_ARVE.ARVE_ARTICULO ORDER BY [@ListaPrecio_PYR_Stock_positivo].CA03_NOMBRE ,IIf([ARTS_CLASIF_10]='0002',NULL,IIf([ARTS_CLASIF_10]='0001',NULL,[CA10_NOMBRE])) ,[@ListaPrecio_PYR_Stock_positivo].[Pre_Cdo_con_IVA_M2] DESC SELECT * FROM @LP_Precios_PYR_con_stock");
    return infoLP.recordsets;
  }
  catch (error){
    console.log(error);
  }
}

async function getListaContenedores(){
  try {
    let pool = await sql.connect(config);
    let infoLista = await pool.request().query("DECLARE @DeposANoConsiderar TABLE(Cod_Depos NUMERIC, Nombre_Deposito VARCHAR(40)) INSERT INTO @DeposANoConsiderar VALUES(10, 'CONT.ALQUILADOS'), (702, 'SCRAP PROVEEDORES'), (901, 'NO APTOS PARA VENTA'), (905, 'EN TRANSITO A REPARA'), (910, 'RECPECION'), (930, 'DEVOL. A PROVEEDORES'), (950, 'SALON NO RESERVABLE'), (973, 'STOCK RESERVADO') DECLARE @NP_a_considerar TABLE (COD_COMP VARCHAR(3), NOMB_COMP VARCHAR(30)) INSERT INTO @NP_a_considerar VALUES ('NPC', 'Nota pedido contado'), ('NPG', 'Nota pedido gerencial'), ('NPT', 'Nota pedido cuanta corriente'), ('PEA', 'Pedido entrega acopio') DECLARE @Movimientos_de_contenedores TABLE (Cod_Cant_Mov VARCHAR(30), Nombre_Movimiento VARCHAR(70), Cant_Mov_Nro NUMERIC) INSERT INTO @Movimientos_de_contenedores VALUES ('00', 'Entrega no requiere movimientos extras', 0), ('01', 'Entrega requiere 1 movimiento extra', 1), ('02', 'Entrega requiere 2 movimientos extras', 2), ('03', 'Engrega requiere 3 movimientos exras', 3), ('04', 'Entrega requiere 4 movimientos extras', 4), ('05', 'Entrega requiere 5 movimientos extras', 5), ('06', 'Entrega requiere 6 movimientos extras', 6), ('07', 'Entrega requiere 7 movimientos extras', 7), ('08', 'Entrega requiere 8 movimienos extras', 8), ('09', 'Entrega requiere 9 movimientos extras', 9), ('10', 'Entrega requiere 10 movimientos extras', 10), ('11', 'Entrega requiere 11 movimientos extras', 11), ('12', 'Entrega requiere 12 movimientos extras', 12), ('13', 'Entrega requiere 13 movimientos extras', 13), ('14', 'Entrega requiere 14 movimientos extras', 14), ('15', 'Entrega requiere 15 movimientos extras', 15), ('16', 'Entrega requiere 16 movimientos extras', 16), ('17', 'Entrega requiere 17 movimientos extras', 17), ('18', 'Entrega requiere 18 movimientos extras', 18), ('19', 'Entrega requiere 19 movimientos extras', 19), ('20', 'Entrega requiere 20 movimientos extras', 20), ('21', 'Entrega requiere 21 movimientos extras', 21), ('22', 'Entrega requiere 22 movimientos extras', 22), ('23', 'Entrega requiere 23 movimientos extras', 23), ('24', 'Entrega requiere 24 movimientos extras', 24), ('25', 'Entrega requiere 25 movimientos extras', 25) DECLARE @DimensionesContenedores TABLE (Clas4_Clas5 VARCHAR(30), Nombre VARCHAR(30), Medidas_interiores NVARCHAR(MAX)) INSERT INTO @DimensionesContenedores VALUES ('00090216','20 pies estándar', 'Ancho 2.35 Alto puerta: 2.27 Alto interior: 2.37 Largo: 6.00 mt.'), ('00090217','40 pies estándar', 'Ancho 2.35 Alto puerta: 2.27 Alto interior: 2.37 Largo: 12.00 mt.'), ('00120217','40 pies higt cube','Ancho 2.35 Alto puerta: 2.57 Alto interior: 2.68 Largo: 12.00 mt.') DECLARE @NP_Pendientes_entregas_1_Contenedores TABLE (NPCA_FECHA_EMI DATETIME ,NPCA_DIVISION_NPCA SMALLINT ,NPCA_TIPO_NPCA VARCHAR(3) ,NPCA_NUMERO_NPCA DECIMAL(10,0) ,ARTS_ARTICULO_EMP VARCHAR(30) ,ARTS_NOMBRE VARCHAR(70) ,NPDE_UNIMED VARCHAR(3) ,NPDE_CANT_PEDIDA DECIMAL(14,4) ,NPDE_CANT_ENTREG DECIMAL(14,4) ,NPDE_MOTIVO_CANC VARCHAR(3) ,Uni_Pte_Entr_NP DECIMAL(14,4) ,ARTS_FACTOR_HOMSTO DECIMAL(20,12) ,ARTS_CLASIF_2 VARCHAR(10) ,CA02_NOMBRE VARCHAR(30) ,NPCA_OBSERVACION NVARCHAR(MAX) ,CLIE_CLIENTE INT ,CLIE_NOMBRE VARCHAR(30)) INSERT INTO @NP_Pendientes_entregas_1_Contenedores SELECT dbo.VENT_NPCA.NPCA_FECHA_EMI ,dbo.VENT_NPCA.NPCA_DIVISION_NPCA ,dbo.VENT_NPCA.NPCA_TIPO_NPCA ,dbo.VENT_NPCA.NPCA_NUMERO_NPCA ,dbo.STOC_ARTS.ARTS_ARTICULO_EMP ,dbo.STOC_ARTS.ARTS_NOMBRE ,dbo.VENT_NPDE.NPDE_UNIMED ,dbo.VENT_NPDE.NPDE_CANT_PEDIDA ,dbo.VENT_NPDE.NPDE_CANT_ENTREG ,dbo.VENT_NPDE.NPDE_MOTIVO_CANC ,[NPDE_CANT_PEDIDA]-[NPDE_CANT_ENTREG] AS [Uni_Pte_Entr_NP] ,dbo.STOC_ARTS.ARTS_FACTOR_HOMSTO ,dbo.STOC_ARTS.ARTS_CLASIF_2 ,dbo.STOC_CA02.CA02_NOMBRE ,dbo.VENT_NPCA.NPCA_OBSERVACION ,dbo.CCOB_CLIE.CLIE_CLIENTE ,dbo.CCOB_CLIE.CLIE_NOMBRE FROM dbo.CCOB_CLIE WITH (NOLOCK) INNER JOIN ((@NP_a_considerar INNER JOIN ((dbo.VENT_NPCA WITH (NOLOCK) INNER JOIN dbo.VENT_NPDE WITH (NOLOCK) ON (dbo.VENT_NPCA.NPCA_DIVISION_NPCA = dbo.VENT_NPDE.NPDE_DIVISION_NPCA) AND (dbo.VENT_NPCA.NPCA_TIPO_NPCA = dbo.VENT_NPDE.NPDE_TIPO_NPCA) AND (dbo.VENT_NPCA.NPCA_NUMERO_NPCA = dbo.VENT_NPDE.NPDE_NUMERO_NPCA)) INNER JOIN dbo.STOC_ARTS WITH (NOLOCK) ON dbo.VENT_NPDE.NPDE_ARTICULO = dbo.STOC_ARTS.ARTS_ARTICULO) ON [@NP_a_considerar].[COD_COMP] = dbo.VENT_NPCA.NPCA_TIPO_NPCA) INNER JOIN dbo.STOC_CA02 WITH (NOLOCK) ON dbo.STOC_ARTS.ARTS_CLASIF_2 = dbo.STOC_CA02.CA02_CLASIF_2) ON dbo.CCOB_CLIE.CLIE_CLIENTE = dbo.VENT_NPCA.NPCA_CLIENTE WHERE (((dbo.VENT_NPDE.NPDE_MOTIVO_CANC) Is Null) AND ((dbo.STOC_ARTS.ARTS_CLASIF_2)='0016')) DECLARE @Stock_Contenedores TABLE (ARTS_ARTICULO INT ,Cód_Art VARCHAR(30) ,Nombre_Art VARCHAR(70) ,Stock_Uni DECIMAL(14,4) ,ARTS_CLASIF_2 VARCHAR(10) ,SDPP_DEPOSITO INT ,DPOS_NOMBRE VARCHAR(20)) INSERT INTO @Stock_Contenedores SELECT dbo.STOC_ARTS.ARTS_ARTICULO ,dbo.STOC_ARTS.ARTS_ARTICULO_EMP AS [Cód_Art] ,dbo.STOC_ARTS.ARTS_NOMBRE AS [Nombre_Art] ,Sum(dbo.STOC_SDPP.SDPP_STOCK_ACT) AS [Stock_Uni] ,dbo.STOC_ARTS.ARTS_CLASIF_2 ,dbo.STOC_SDPP.SDPP_DEPOSITO ,dbo.STOC_DPOS.DPOS_NOMBRE FROM ((dbo.STOC_ARTS WITH (NOLOCK) LEFT JOIN dbo.STOC_SDPP WITH (NOLOCK) ON dbo.STOC_ARTS.ARTS_ARTICULO = dbo.STOC_SDPP.SDPP_ARTICULO) LEFT JOIN @DeposANoConsiderar ON dbo.STOC_SDPP.SDPP_DEPOSITO = [@DeposANoConsiderar].[Cod_Depos]) LEFT JOIN dbo.STOC_DPOS WITH (NOLOCK) ON dbo.STOC_SDPP.SDPP_DEPOSITO = dbo.STOC_DPOS.DPOS_DEPOSITO GROUP BY dbo.STOC_ARTS.ARTS_ARTICULO ,dbo.STOC_ARTS.ARTS_ARTICULO_EMP ,dbo.STOC_ARTS.ARTS_NOMBRE ,dbo.STOC_ARTS.ARTS_CLASIF_2 ,dbo.STOC_SDPP.SDPP_DEPOSITO ,dbo.STOC_DPOS.DPOS_NOMBRE ,[@DeposANoConsiderar].[Nombre_Deposito] HAVING (((dbo.STOC_ARTS.ARTS_CLASIF_2)='0016') AND (([@DeposANoConsiderar].Nombre_Deposito) Is Null)) DECLARE @Lista_precio_1 TABLE (ARTS_ARTICULO_EMP VARCHAR(30) ,ARTS_NOMBRE VARCHAR(70) ,ARPV_ARTICULO INT ,ARPV_LISTA_PRECVTA INT ,ARPV_PRECIO_VTA DECIMAL(14,2) ,ARPV_MONEDA VARCHAR(3) ,MáxDeCOTI_FECHA DATETIME ,CIMP_TASA DECIMAL (7,4) ) INSERT INTO @Lista_precio_1 SELECT dbo.STOC_ARTS.ARTS_ARTICULO_EMP ,dbo.STOC_ARTS.ARTS_NOMBRE ,dbo.VENT_ARPV.ARPV_ARTICULO ,dbo.VENT_ARPV.ARPV_LISTA_PRECVTA ,dbo.VENT_ARPV.ARPV_PRECIO_VTA ,dbo.VENT_ARPV.ARPV_MONEDA ,Max(dbo.SIST_COTI.COTI_FECHA) AS MáxDeCOTI_FECHA ,dbo.SIST_CIMP.CIMP_TASA FROM dbo.STOC_ARTS WITH (NOLOCK) INNER JOIN (((dbo.VENT_ARPV WITH (NOLOCK) LEFT JOIN dbo.SIST_COTI WITH (NOLOCK) ON dbo.VENT_ARPV.ARPV_MONEDA = dbo.SIST_COTI.COTI_MONEDA1) INNER JOIN dbo.VENT_ARVI WITH (NOLOCK) ON dbo.VENT_ARPV.ARPV_ARTICULO = dbo.VENT_ARVI.ARVI_ARTICULO) INNER JOIN dbo.SIST_CIMP WITH (NOLOCK) ON (dbo.VENT_ARVI.ARVI_CATEGORIA_IMP = dbo.SIST_CIMP.CIMP_CATEGORIA_IMP) AND (dbo.VENT_ARVI.ARVI_IMPUESTO = dbo.SIST_CIMP.CIMP_IMPUESTO)) ON dbo.STOC_ARTS.ARTS_ARTICULO = dbo.VENT_ARPV.ARPV_ARTICULO GROUP BY dbo.STOC_ARTS.ARTS_ARTICULO_EMP ,dbo.STOC_ARTS.ARTS_NOMBRE ,dbo.VENT_ARPV.ARPV_ARTICULO ,dbo.VENT_ARPV.ARPV_LISTA_PRECVTA ,dbo.VENT_ARPV.ARPV_PRECIO_VTA ,dbo.VENT_ARPV.ARPV_MONEDA ,dbo.SIST_CIMP.CIMP_TASA HAVING (((dbo.VENT_ARPV.ARPV_LISTA_PRECVTA)=1)) ORDER BY Max(dbo.SIST_COTI.COTI_FECHA) DECLARE @Lista_precio_1_2 TABLE (ARTS_ARTICULO_EMP VARCHAR(30) ,ARTS_NOMBRE VARCHAR(70) ,ARPV_ARTICULO INT ,ARPV_LISTA_PRECVTA INT ,ARPV_PRECIO_VTA DECIMAL(14,2) ,ARPV_MONEDA VARCHAR(3) ,COTI_COTIZACION DECIMAL(14,2) ,CIMP_TASA DECIMAL (7,2) ,PRECIO_BASE_PESOS DECIMAL (14,2) ,Pre_Lista_con_IVA_L1 DECIMAL (14,2) ,Pre_Cdo_con_IVA_L1 DECIMAL (14,2) ) INSERT INTO @Lista_precio_1_2 SELECT [@Lista_precio_1].ARTS_ARTICULO_EMP ,[@Lista_precio_1].ARTS_NOMBRE ,[@Lista_precio_1].ARPV_ARTICULO ,[@Lista_precio_1].ARPV_LISTA_PRECVTA ,[@Lista_precio_1].ARPV_PRECIO_VTA ,[@Lista_precio_1].ARPV_MONEDA ,dbo.SIST_COTI.COTI_COTIZACION ,[@Lista_precio_1].CIMP_TASA ,(CASE WHEN COTI_COTIZACION = [COTI_COTIZACION] THEN ([ARPV_PRECIO_VTA]*[COTI_COTIZACION]) ELSE [ARPV_PRECIO_VTA] END) AS [PRECIO_BASE_PESOS] ,Round((CASE WHEN COTI_COTIZACION = [COTI_COTIZACION] THEN ([ARPV_PRECIO_VTA]*[COTI_COTIZACION]) ELSE [ARPV_PRECIO_VTA] END)*(1+[CIMP_TASA]/100), 2) AS [Pre_Lista_con_IVA_L1] ,Round((CASE WHEN COTI_COTIZACION = [COTI_COTIZACION] THEN ([ARPV_PRECIO_VTA]*[COTI_COTIZACION]) ELSE [ARPV_PRECIO_VTA] END)*0.8*(1+[CIMP_TASA]/100), 2) AS [Pre_Cdo_con_IVA_L1] FROM @Lista_precio_1 LEFT JOIN dbo.SIST_COTI WITH (NOLOCK) ON ([@Lista_precio_1].MáxDeCOTI_FECHA = dbo.SIST_COTI.COTI_FECHA) AND ([@Lista_precio_1].ARPV_MONEDA = dbo.SIST_COTI.COTI_MONEDA1) DECLARE @Containers_1 TABLE (CA05_NOMBRE VARCHAR(30) ,Longitud VARCHAR(30) ,CA04_NOMBRE VARCHAR(30) ,Tipo VARCHAR(30) ,ARTS_ARTICULO_EMP VARCHAR(30) ,ARTS_NOMBRE VARCHAR(70) ,Stock_Uni DECIMAL(14,0) ,Uni_Pte_Entr_NP DECIMAL(14,0) ,Stk_Disp_pVta DECIMAL(14,0) ,ARPV_PRECIO_VTA DECIMAL(14,2) ,Pre_Lista_USD_con_IVA DECIMAL(14,2) ,Pre_Cdo_USD_con_IVA DECIMAL(14,2) ,Pre_Lista_con_IVA_L1 DECIMAL (14,2) ,Pre_Cdo_con_IVA_L1 DECIMAL (14,2) ,ARPV_MONEDA VARCHAR(3) ,Moneda_del_Precio_Lista_en_USD NVARCHAR(MAX) ,Cotización DECIMAL(14,1) ,CIMP_TASA DECIMAL (7,1) ,CA03_NOMBRE VARCHAR(30) ,Año_de_fabricación VARCHAR(4) ,NPCA_OBSERVACION NVARCHAR(MAX) ,VEND_NOMBRE VARCHAR(30) ,Nro_cliente INT ,Nombre_Cliente VARCHAR(30) ,SDPP_DEPOSITO INT ,DPOS_NOMBRE VARCHAR(20) ,ARTS_CLASIF_4 VARCHAR(10) ,ARTS_CLASIF_5 VARCHAR(10) ,Clas4_Clas5_CTD VARCHAR(20) ,ARTS_PESO_EMB_UMS DECIMAL(14,0) ,PART_PARTIDA_ORI VARCHAR(20) ,Cod_Mov VARCHAR(20)) INSERT INTO @Containers_1 SELECT dbo.STOC_CA05.CA05_NOMBRE ,Right(dbo.STOC_CA05.[CA05_NOMBRE],7) AS Longitud ,dbo.STOC_CA04.CA04_NOMBRE ,Right(dbo.STOC_CA04.[CA04_NOMBRE],Len(dbo.STOC_CA04.[CA04_NOMBRE])-6) AS Tipo ,dbo.STOC_ARTS.ARTS_ARTICULO_EMP ,dbo.STOC_ARTS.ARTS_NOMBRE ,[@Stock_Contenedores].[Stock_Uni] ,[@NP_Pendientes_entregas_1_Contenedores].[Uni_Pte_Entr_NP] ,[@Stock_Contenedores].[Stock_Uni]-ISNULL([@NP_Pendientes_entregas_1_Contenedores].[Uni_Pte_Entr_NP],0) AS [Stk_Disp_pVta] ,[@Lista_precio_1_2].ARPV_PRECIO_VTA ,[@Lista_precio_1_2].ARPV_PRECIO_VTA*(1+[@Lista_precio_1_2].CIMP_TASA/100) AS [Pre_Lista_USD_con_IVA] ,[@Lista_precio_1_2].ARPV_PRECIO_VTA*(1+[@Lista_precio_1_2].CIMP_TASA/100)*0.8 AS [Pre_Cdo_USD_con_IVA] ,[@Lista_precio_1_2].[Pre_Lista_con_IVA_L1] ,[@Lista_precio_1_2].[Pre_Cdo_con_IVA_L1] ,[@Lista_precio_1_2].ARPV_MONEDA ,IIf([@Lista_precio_1_2].ARPV_MONEDA='DCT','Dólar Cotización Billete VENTA BNA',[@Lista_precio_1_2].ARPV_MONEDA) AS [Moneda_del_Precio_Lista_en_USD] ,[@Lista_precio_1_2].COTI_COTIZACION AS Cotización ,[@Lista_precio_1_2].CIMP_TASA ,dbo.STOC_CA03.CA03_NOMBRE ,Right(dbo.STOC_CA03.[CA03_NOMBRE],4) AS [Año_de_fabricación] ,[@NP_Pendientes_entregas_1_Contenedores].NPCA_OBSERVACION ,dbo.SIST_VEND.VEND_NOMBRE ,[@NP_Pendientes_entregas_1_Contenedores].CLIE_CLIENTE AS [Nro_cliente] ,[@NP_Pendientes_entregas_1_Contenedores].CLIE_NOMBRE AS [Nombre_Cliente] ,[@Stock_Contenedores].SDPP_DEPOSITO ,[@Stock_Contenedores].DPOS_NOMBRE ,dbo.STOC_ARTS.ARTS_CLASIF_4 ,dbo.STOC_ARTS.ARTS_CLASIF_5 ,dbo.STOC_ARTS.[ARTS_CLASIF_4] + dbo.STOC_ARTS.[ARTS_CLASIF_5] AS [Clas4_Clas5_CTD] ,dbo.STOC_ARTS.ARTS_PESO_EMB_UMS ,dbo.STOC_PART.PART_PARTIDA_ORI ,Left(dbo.STOC_PART.[PART_PARTIDA_ORI],2) AS [Cod_Mov] FROM ((((@NP_Pendientes_entregas_1_Contenedores RIGHT JOIN ((((dbo.STOC_ARTS WITH (NOLOCK) INNER JOIN @Lista_precio_1_2 ON dbo.STOC_ARTS.ARTS_ARTICULO_EMP = [@Lista_precio_1_2].ARTS_ARTICULO_EMP) INNER JOIN dbo.STOC_CA03 WITH (NOLOCK) ON dbo.STOC_ARTS.ARTS_CLASIF_3 = dbo.STOC_CA03.CA03_CLASIF_3) INNER JOIN dbo.STOC_CA04 WITH (NOLOCK) ON dbo.STOC_ARTS.ARTS_CLASIF_4 = dbo.STOC_CA04.CA04_CLASIF_4) INNER JOIN dbo.STOC_CA05 WITH (NOLOCK) ON dbo.STOC_ARTS.ARTS_CLASIF_5 = dbo.STOC_CA05.CA05_CLASIF_5) ON [@NP_Pendientes_entregas_1_Contenedores].ARTS_ARTICULO_EMP = dbo.STOC_ARTS.ARTS_ARTICULO_EMP) LEFT JOIN dbo.VENT_NPVE WITH (NOLOCK) ON ([@NP_Pendientes_entregas_1_Contenedores].NPCA_NUMERO_NPCA = dbo.VENT_NPVE.NPVE_NUMERO_NPCA) AND ([@NP_Pendientes_entregas_1_Contenedores].NPCA_TIPO_NPCA = dbo.VENT_NPVE.NPVE_TIPO_NPCA) AND ([@NP_Pendientes_entregas_1_Contenedores].NPCA_DIVISION_NPCA = dbo.VENT_NPVE.NPVE_DIVISION_NPCA)) LEFT JOIN dbo.SIST_VEND WITH (NOLOCK) ON dbo.VENT_NPVE.NPVE_VENDEDOR = dbo.SIST_VEND.VEND_VENDEDOR) LEFT JOIN @Stock_Contenedores ON dbo.STOC_ARTS.ARTS_ARTICULO = [@Stock_Contenedores].ARTS_ARTICULO) INNER JOIN dbo.STOC_PART WITH (NOLOCK) ON dbo.STOC_ARTS.ARTS_ARTICULO = dbo.STOC_PART.PART_ARTICULO WHERE ((([@Stock_Contenedores].[Stock_Uni])>0) AND ((dbo.STOC_ARTS.ARTS_CLASIF_2)='0016')) ORDER BY dbo.STOC_CA05.CA05_NOMBRE ,dbo.STOC_CA04.CA04_NOMBRE ,[@Lista_precio_1_2].ARPV_PRECIO_VTA DESC DECLARE @Contenedor_precio_movimiento TABLE (ARTS_ARTICULO_EMP VARCHAR(30) ,ARTS_NOMBRE VARCHAR(70) ,ARPV_ARTICULO INT ,ARPV_LISTA_PRECVTA INT ,ARPV_PRECIO_VTA DECIMAL(14,2) ,ARPV_MONEDA VARCHAR(3) ,COTI_COTIZACION DECIMAL(14,2) ,CIMP_TASA DECIMAL (7,2) ,Precio_base_pesos_SI DECIMAL (14,2) ,Pre_Lista_con_IVA_L1_2 DECIMAL (14,2) ,Pre_Cdo_con_IVA_L1_2 DECIMAL (14,2) ) INSERT INTO @Contenedor_precio_movimiento SELECT [@Lista_precio_1].ARTS_ARTICULO_EMP ,[@Lista_precio_1].ARTS_NOMBRE ,[@Lista_precio_1].ARPV_ARTICULO ,[@Lista_precio_1].ARPV_LISTA_PRECVTA ,[@Lista_precio_1].ARPV_PRECIO_VTA ,[@Lista_precio_1].ARPV_MONEDA ,dbo.SIST_COTI.COTI_COTIZACION ,[@Lista_precio_1].CIMP_TASA ,(CASE WHEN COTI_COTIZACION = [COTI_COTIZACION] THEN ([ARPV_PRECIO_VTA]*[COTI_COTIZACION]) ELSE [ARPV_PRECIO_VTA] END) AS [Precio_base_pesos_SI] ,Round((CASE WHEN COTI_COTIZACION = [COTI_COTIZACION] THEN ([ARPV_PRECIO_VTA]*[COTI_COTIZACION]) ELSE [ARPV_PRECIO_VTA] END)*(1+[CIMP_TASA]/100), 2) AS [Pre_Lista_con_IVA_L1_2] ,Round((CASE WHEN COTI_COTIZACION = [COTI_COTIZACION] THEN ([ARPV_PRECIO_VTA]*[COTI_COTIZACION]) ELSE [ARPV_PRECIO_VTA] END)*0.8*(1+[CIMP_TASA]/100), 2) AS [Pre_Cdo_con_IVA_L1_2] FROM @Lista_precio_1 LEFT JOIN dbo.SIST_COTI WITH (NOLOCK) ON ([@Lista_precio_1].MáxDeCOTI_FECHA = dbo.SIST_COTI.COTI_FECHA) AND ([@Lista_precio_1].ARPV_MONEDA = dbo.SIST_COTI.COTI_MONEDA1) WHERE ((([@Lista_precio_1].ARTS_ARTICULO_EMP)='01500026')) DECLARE @Containers_2 TABLE (CA05_NOMBRE VARCHAR(30) ,Longitud VARCHAR(30) ,CA04_NOMBRE VARCHAR(30) ,Tipo VARCHAR(30) ,ARTS_ARTICULO_EMP VARCHAR(30) ,ARTS_NOMBRE VARCHAR(70) ,Stock_Uni DECIMAL(14,0) ,Uni_Pte_Entr_NP DECIMAL(14,0) ,Stk_Disp_pVta DECIMAL(14,0) ,ARPV_PRECIO_VTA DECIMAL(14,2) ,Pre_Lista_USD_con_IVA DECIMAL(14,2) ,Pre_Cdo_USD_con_IVA DECIMAL(14,2) ,Pre_Lista_con_IVA_L1 DECIMAL (14,2) ,Pre_Cdo_con_IVA_L1 DECIMAL (14,2) ,ARPV_MONEDA VARCHAR(3) ,Moneda_del_Precio_Lista_en_USD NVARCHAR(MAX) ,Cotización DECIMAL(14,1) ,CIMP_TASA DECIMAL (7,1) ,CA03_NOMBRE VARCHAR(30) ,Año_de_fabricación VARCHAR(4) ,NPCA_OBSERVACION NVARCHAR(MAX) ,VEND_NOMBRE VARCHAR(30) ,Nro_cliente INT ,Nombre_Cliente VARCHAR(30) ,SDPP_DEPOSITO INT ,DPOS_NOMBRE VARCHAR(20) ,ARTS_CLASIF_4 VARCHAR(10) ,ARTS_CLASIF_5 VARCHAR(10) ,Clas4_Clas5_CTD VARCHAR(20) ,ARTS_PESO_EMB_UMS DECIMAL(14,0) ,PART_PARTIDA_ORI VARCHAR(20) ,Cod_Mov VARCHAR(20) ,Nombre_Movimiento VARCHAR(70) ,Cant_Mov_Nro NUMERIC) INSERT INTO @Containers_2 SELECT [@Containers_1].CA05_NOMBRE ,[@Containers_1].Longitud ,[@Containers_1].CA04_NOMBRE ,[@Containers_1].Tipo ,[@Containers_1].ARTS_ARTICULO_EMP ,[@Containers_1].ARTS_NOMBRE ,[@Containers_1].[Stock_Uni] ,[@Containers_1].[Uni_Pte_Entr_NP] ,[@Containers_1].[Stk_Disp_pVta] ,[@Containers_1].ARPV_PRECIO_VTA ,[@Containers_1].[Pre_Lista_USD_con_IVA] ,[@Containers_1].[Pre_Cdo_USD_con_IVA] ,[@Containers_1].[Pre_Lista_con_IVA_L1] ,[@Containers_1].[Pre_Cdo_con_IVA_L1] ,[@Containers_1].ARPV_MONEDA ,[@Containers_1].[Moneda_del_Precio_Lista_en_USD] ,[@Containers_1].Cotización ,[@Containers_1].CIMP_TASA ,[@Containers_1].CA03_NOMBRE ,[@Containers_1].[Año_de_fabricación] ,[@Containers_1].NPCA_OBSERVACION ,[@Containers_1].VEND_NOMBRE ,[@Containers_1].[Nro_cliente] ,[@Containers_1].[Nombre_Cliente] ,[@Containers_1].SDPP_DEPOSITO ,[@Containers_1].DPOS_NOMBRE ,[@Containers_1].ARTS_CLASIF_4 ,[@Containers_1].ARTS_CLASIF_5 ,[@Containers_1].[Clas4_Clas5_CTD] ,[@Containers_1].ARTS_PESO_EMB_UMS ,[@Containers_1].PART_PARTIDA_ORI ,[@Containers_1].[Cod_Mov] ,[@Movimientos_de_contenedores].[Nombre_Movimiento] ,[@Movimientos_de_contenedores].[Cant_Mov_Nro] FROM @Containers_1 LEFT JOIN @Movimientos_de_contenedores ON [@Containers_1].[Cod_Mov] = [@Movimientos_de_contenedores].[Cod_Cant_Mov] DECLARE @Containers_3 TABLE (CA05_NOMBRE VARCHAR(30) ,Longitud VARCHAR(30) ,CA04_NOMBRE VARCHAR(30) ,Tipo VARCHAR(30) ,ARTS_ARTICULO_EMP VARCHAR(30) ,ARTS_NOMBRE VARCHAR(70) ,Stock_Uni DECIMAL(14,0) ,Uni_Pte_Entr_NP DECIMAL(14,0) ,Stk_Disp_pVta DECIMAL(14,0) ,ARPV_PRECIO_VTA DECIMAL(14,2) ,Pre_Lista_USD_con_IVA DECIMAL(14,2) ,Pre_Cdo_USD_con_IVA DECIMAL(14,2) ,Pre_Lista_con_IVA_L1 DECIMAL (14,2) ,Pre_Cdo_con_IVA_L1 DECIMAL (14,2) ,ARPV_MONEDA VARCHAR(3) ,Moneda_del_Precio_Lista_en_USD NVARCHAR(MAX) ,Cotización DECIMAL(14,1) ,CIMP_TASA DECIMAL (7,1) ,CA03_NOMBRE VARCHAR(30) ,Año_de_fabricación VARCHAR(4) ,NPCA_OBSERVACION NVARCHAR(MAX) ,VEND_NOMBRE VARCHAR(30) ,Nro_cliente INT ,Nombre_Cliente VARCHAR(30) ,SDPP_DEPOSITO INT ,DPOS_NOMBRE VARCHAR(20) ,ARTS_CLASIF_4 VARCHAR(10) ,ARTS_CLASIF_5 VARCHAR(10) ,Clas4_Clas5_CTD VARCHAR(20) ,ARTS_PESO_EMB_UMS DECIMAL(14,0) ,PART_PARTIDA_ORI VARCHAR(20) ,Cod_Mov VARCHAR(20) ,Nombre_Movimiento VARCHAR(70) ,Cant_Mov_Nro NUMERIC ,Pre_Cdo_con_IVA_L1_2 DECIMAL(14,2)) INSERT INTO @Containers_3 SELECT [@Containers_2].CA05_NOMBRE ,[@Containers_2].Longitud ,[@Containers_2].CA04_NOMBRE ,[@Containers_2].Tipo ,[@Containers_2].ARTS_ARTICULO_EMP ,[@Containers_2].ARTS_NOMBRE ,[@Containers_2].[Stock_Uni] ,[@Containers_2].[Uni_Pte_Entr_NP] ,[@Containers_2].[Stk_Disp_pVta] ,[@Containers_2].ARPV_PRECIO_VTA ,[@Containers_2].[Pre_Lista_USD_con_IVA] ,[@Containers_2].[Pre_Cdo_USD_con_IVA] ,[@Containers_2].[Pre_Lista_con_IVA_L1] ,[@Containers_2].[Pre_Cdo_con_IVA_L1] ,[@Containers_2].ARPV_MONEDA ,[@Containers_2].[Moneda_del_Precio_Lista_en_USD] ,[@Containers_2].Cotización ,[@Containers_2].CIMP_TASA ,[@Containers_2].CA03_NOMBRE ,[@Containers_2].[Año_de_fabricación] ,[@Containers_2].NPCA_OBSERVACION ,[@Containers_2].VEND_NOMBRE ,[@Containers_2].[Nro_cliente] ,[@Containers_2].[Nombre_Cliente] ,[@Containers_2].SDPP_DEPOSITO ,[@Containers_2].DPOS_NOMBRE ,[@Containers_2].ARTS_CLASIF_4 ,[@Containers_2].ARTS_CLASIF_5 ,[@Containers_2].[Clas4_Clas5_CTD] ,[@Containers_2].ARTS_PESO_EMB_UMS ,[@Containers_2].PART_PARTIDA_ORI ,[@Containers_2].[Cod_Mov] ,[@Containers_2].[Nombre_Movimiento] ,[@Containers_2].[Cant_Mov_Nro] ,[@Contenedor_precio_movimiento].[Pre_Cdo_con_IVA_L1_2] FROM @Containers_2 ,@Contenedor_precio_movimiento DECLARE @Containers_4 TABLE (CA05_NOMBRE VARCHAR(30) ,Longitud VARCHAR(30) ,CA04_NOMBRE VARCHAR(30) ,Tipo VARCHAR(30) ,ARTS_ARTICULO_EMP VARCHAR(30) ,ARTS_NOMBRE VARCHAR(70) ,Stock_Uni DECIMAL(14,0) ,Uni_Pte_Entr_NP DECIMAL(14,0) ,Stk_Disp_pVta DECIMAL(14,0) ,ARPV_PRECIO_VTA DECIMAL(14,2) ,Pre_Lista_USD_con_IVA DECIMAL(14,2) ,Pre_Cdo_USD_con_IVA DECIMAL(14,2) ,Pre_Lista_con_IVA_L1 DECIMAL (14,2) ,Pre_Cdo_AR_cIVA_L1 DECIMAL (14,2) ,ARPV_MONEDA VARCHAR(3) ,Moneda_del_Precio_Lista_en_USD NVARCHAR(MAX) ,Cotización DECIMAL(14,1) ,CIMP_TASA DECIMAL (7,1) ,CA03_NOMBRE VARCHAR(30) ,Año_de_fabricación VARCHAR(4) ,NPCA_OBSERVACION NVARCHAR(MAX) ,VEND_NOMBRE VARCHAR(30) ,Nro_cliente INT ,Nombre_Cliente VARCHAR(30) ,SDPP_DEPOSITO INT ,DPOS_NOMBRE VARCHAR(20) ,ARTS_CLASIF_4 VARCHAR(10) ,ARTS_CLASIF_5 VARCHAR(10) ,Clas4_Clas5_CTD VARCHAR(20) ,ARTS_PESO_EMB_UMS DECIMAL(14,0) ,PART_PARTIDA_ORI VARCHAR(20) ,Cod_Mov VARCHAR(20) ,Nombre_Movimiento VARCHAR(70) ,Cant_Mov_Nro NUMERIC ,Pre_Cdo_con_IVA_L1_2 DECIMAL(14,2) ,Precio_ARxmov_01500026 DECIMAL(14,2) ,Total_mov DECIMAL(14,2) ,Contenedor_c_mov_AR_cdo_efect DECIMAL(14,2)) INSERT INTO @Containers_4 SELECT [@Containers_3].CA05_NOMBRE ,[@Containers_3].Longitud ,[@Containers_3].CA04_NOMBRE ,[@Containers_3].Tipo ,[@Containers_3].ARTS_ARTICULO_EMP ,[@Containers_3].ARTS_NOMBRE ,[@Containers_3].[Stock_Uni] ,[@Containers_3].[Uni_Pte_Entr_NP] ,[@Containers_3].[Stk_Disp_pVta] ,[@Containers_3].ARPV_PRECIO_VTA ,[@Containers_3].[Pre_Lista_USD_con_IVA] ,[@Containers_3].[Pre_Cdo_USD_con_IVA] ,[@Containers_3].[Pre_Lista_con_IVA_L1] ,[@Containers_3].[Pre_Cdo_con_IVA_L1] AS [Pre_Cdo_AR_cIVA_L1] ,[@Containers_3].ARPV_MONEDA ,[@Containers_3].[Moneda_del_Precio_Lista_en_USD] ,[@Containers_3].Cotización ,[@Containers_3].CIMP_TASA ,[@Containers_3].CA03_NOMBRE ,[@Containers_3].[Año_de_fabricación] ,[@Containers_3].NPCA_OBSERVACION ,[@Containers_3].VEND_NOMBRE ,[@Containers_3].[Nro_cliente] ,[@Containers_3].[Nombre_Cliente] ,[@Containers_3].SDPP_DEPOSITO ,[@Containers_3].DPOS_NOMBRE ,[@Containers_3].ARTS_CLASIF_4 ,[@Containers_3].ARTS_CLASIF_5 ,[@Containers_3].[Clas4_Clas5_CTD] ,[@Containers_3].ARTS_PESO_EMB_UMS ,[@Containers_3].PART_PARTIDA_ORI ,[@Containers_3].[Cod_Mov] ,[@Containers_3].[Nombre_Movimiento] ,[@Containers_3].[Cant_Mov_Nro] ,[@Containers_3].[Pre_Cdo_con_IVA_L1_2] ,IIf([@Containers_3].Cant_Mov_Nro > 0,[@Containers_3].[Pre_Cdo_con_IVA_L1_2],NULL) AS [Precio_ARxmov_01500026] ,[@Containers_3].[Pre_Cdo_con_IVA_L1_2]*[@Containers_3].[Cant_Mov_Nro] AS [Total_mov] ,[@Containers_3].[Pre_Cdo_con_IVA_L1]+ISNULL([@Containers_3].[Pre_Cdo_con_IVA_L1_2]*[@Containers_3].[Cant_Mov_Nro], NULL) AS [Contenedor_c_mov_AR_cdo_efect] FROM @Containers_3 SELECT IIf([Pre_Cdo_AR_cIVA_L1]=[Contenedor_c_mov_AR_cdo_efect],'No requiere mov','¡¡¡Requiere mov!!!') AS [Movimientos] ,[@Containers_4].Longitud ,[@Containers_4].Tipo ,[@Containers_4].ARTS_ARTICULO_EMP AS [Cód_Art] ,[@Containers_4].ARTS_NOMBRE AS [Nombre_art] ,[@Containers_4].[Stock_Uni] ,[@Containers_4].[Uni_Pte_Entr_NP] ,[@Containers_4].[Stk_Disp_pVta] ,[@Containers_4].[Pre_Cdo_USD_con_IVA] ,[@Containers_4].[Pre_Cdo_AR_cIVA_L1] ,[@Containers_4].[Cant_Mov_Nro] ,[@Containers_4].[Precio_ARxmov_01500026] ,[@Containers_4].[Total_mov] ,[@Containers_4].[Contenedor_c_mov_AR_cdo_efect] ,[@Containers_4].DPOS_NOMBRE AS Depósito ,[@Containers_4].[Moneda_del_Precio_Lista_en_USD] ,[@Containers_4].Cotización ,CONVERT(VARCHAR(30),[@Containers_4].[CIMP_TASA]) + ' %' AS [IVA_incluido_en_precio] ,[@Containers_4].[Año_de_fabricación] ,[@Containers_4].ARTS_PESO_EMB_UMS AS [Peso_aprox_Kg] ,[@Containers_4].[Nro_cliente] ,[@Containers_4].[Nombre_Cliente] ,[@Containers_4].NPCA_OBSERVACION AS [Observación_NP] ,[@Containers_4].VEND_NOMBRE AS Vendedor ,[@DimensionesContenedores].[Medidas_interiores] FROM @Containers_4 INNER JOIN @DimensionesContenedores ON [@Containers_4].[Clas4_Clas5_CTD] = [@DimensionesContenedores].[Clas4_Clas5] ORDER BY [@Containers_4].Longitud ,[@Containers_4].Tipo DESC ,[@Containers_4].[Pre_Cdo_USD_con_IVA]");
    return infoLista.recordsets;
  }
  catch (error){
    console.log(error);
  }
}

async function getNPpendienteEntregaContenedores() {
  try {
    let pool = await sql.connect(config);
    let infoPendiente = await pool.request().query("SELECT FORMAT(CAST(dbo.VENT_NPCA.NPCA_FECHA_EMI as DATE), 'yyyy-MM-dd') AS [NPCA_FECHA_EMI] ,dbo.VENT_NPCA.NPCA_DIVISION_NPCA ,dbo.VENT_NPCA.NPCA_TIPO_NPCA ,dbo.VENT_NPCA.NPCA_NUMERO_NPCA ,dbo.STOC_ARTS.ARTS_ARTICULO_EMP ,dbo.STOC_ARTS.ARTS_NOMBRE ,dbo.VENT_NPDE.NPDE_UNIMED ,dbo.VENT_NPDE.NPDE_CANT_PEDIDA ,dbo.VENT_NPDE.NPDE_CANT_ENTREG ,dbo.VENT_NPDE.NPDE_MOTIVO_CANC ,[NPDE_CANT_PEDIDA]-[NPDE_CANT_ENTREG] AS [Uni Pte Entr NP] ,dbo.STOC_ARTS.ARTS_FACTOR_HOMSTO ,dbo.STOC_ARTS.ARTS_CLASIF_2 ,dbo.STOC_CA02.CA02_NOMBRE ,dbo.VENT_NPCA.NPCA_OBSERVACION ,dbo.CCOB_CLIE.CLIE_CLIENTE ,dbo.CCOB_CLIE.CLIE_NOMBRE FROM dbo.CCOB_CLIE WITH(NOLOCK) INNER JOIN (((dbo.VENT_NPCA WITH (NOLOCK) INNER JOIN dbo.VENT_NPDE WITH (NOLOCK) ON (dbo.VENT_NPCA.NPCA_DIVISION_NPCA = dbo.VENT_NPDE.NPDE_DIVISION_NPCA) AND (dbo.VENT_NPCA.NPCA_TIPO_NPCA = dbo.VENT_NPDE.NPDE_TIPO_NPCA) AND (dbo.VENT_NPCA.NPCA_NUMERO_NPCA = dbo.VENT_NPDE.NPDE_NUMERO_NPCA)) INNER JOIN dbo.STOC_ARTS WITH (NOLOCK) ON dbo.VENT_NPDE.NPDE_ARTICULO = dbo.STOC_ARTS.ARTS_ARTICULO) INNER JOIN dbo.STOC_CA02 WITH (NOLOCK) ON dbo.STOC_ARTS.ARTS_CLASIF_2 = dbo.STOC_CA02.CA02_CLASIF_2) ON dbo.CCOB_CLIE.CLIE_CLIENTE = dbo.VENT_NPCA.NPCA_CLIENTE WHERE (((dbo.VENT_NPDE.NPDE_MOTIVO_CANC) Is Null) AND ((dbo.STOC_ARTS.ARTS_CLASIF_2)='0016'))");
    return infoPendiente.recordsets;
  }
  catch (error){
    console.log(error);
  }
}

async function getControl() {
    try {
      let  pool = await  sql.connect(config);
      let  info = await  pool.request().query("SELECT FORMAT(CAST(dbo.CCOB_CLIE.CLIE_FECHA_ALTA as DATE), 'yyyy-MM-dd') AS [CLIE_FECHA_ALTA] ,dbo.SEGU_AUDI.AUDI_USUARIO ,dbo.SEGU_USUA.USUA_NOMBRE ,dbo.SIST_VEND.VEND_NOMBRE ,dbo.CCOB_CLIE.CLIE_CLIENTE ,dbo.CCOB_CLIE.CLIE_NOMBRE ,dbo.CCOB_CLIE.CLIE_EMAIL ,dbo.CCOB_CLC5.CLC5_NOMBRE ,dbo.CCOB_DCLI.DCLI_DOMICILIO ,dbo.CCOB_DCLI.DCLI_LOCALIDAD ,dbo.CCOB_DCLI.DCLI_COD_LOCALIDAD ,dbo.CCOB_DCLI.DCLI_COD_POSTAL ,dbo.CCOB_DCLI.DCLI_PROVINCIA ,dbo.CCOB_CLIE.CLIE_CONDICION_IVA ,dbo.CCOB_CLIE.CLIE_CUIT ,dbo.CCOB_CLIE.CLIE_ING_BRUTOS ,dbo.CCOB_CLIE.CLIE_COND_PAGO ,dbo.CCOB_CLIE.CLIE_COBRADOR ,dbo.CCOB_CLPF.CLPF_FECHA_NACIM ,dbo.CCOB_CLPF.CLPF_NACIONALIDAD ,dbo.CCOB_CLPF.CLPF_SEXO FROM(((dbo.SEGU_AUDI WITH (NOLOCK) INNER JOIN dbo.CCOB_AUCL WITH (NOLOCK) ON dbo.SEGU_AUDI.AUDI_AUDITOR = dbo.CCOB_AUCL.AUCL_AUDITOR) INNER JOIN dbo.SEGU_USUA WITH (NOLOCK) ON dbo.SEGU_AUDI.AUDI_USUARIO = dbo.SEGU_USUA.USUA_USUARIO) INNER JOIN (((dbo.CCOB_CLIE WITH (NOLOCK) INNER JOIN dbo.CCOB_DCLI WITH (NOLOCK) ON dbo.CCOB_CLIE.CLIE_CLIENTE = dbo.CCOB_DCLI.DCLI_CLIENTE) LEFT JOIN dbo.CCOB_CLPF WITH (NOLOCK) ON dbo.CCOB_CLIE.CLIE_CLIENTE = dbo.CCOB_CLPF.CLPF_CLIENTE) INNER JOIN dbo.CCOB_CLC5 WITH (NOLOCK) ON dbo.CCOB_CLIE.CLIE_CLASIF_5 = dbo.CCOB_CLC5.CLC5_CLASIF_5) ON dbo.CCOB_AUCL.AUCL_CLIENTE = dbo.CCOB_CLIE.CLIE_CLIENTE) INNER JOIN (dbo.CCOB_VECL WITH (NOLOCK) INNER JOIN dbo.SIST_VEND WITH (NOLOCK) ON dbo.CCOB_VECL.VECL_VENDEDOR = dbo.SIST_VEND.VEND_VENDEDOR) ON dbo.CCOB_CLIE.CLIE_CLIENTE = dbo.CCOB_VECL.VECL_CLIENTE WHERE (((dbo.SEGU_AUDI.AUDI_INSERTA)=1))");
      return  info.recordsets;
    }
    catch (error) {
      console.log(error);
    }
  }

  async function getListaClientes(){
    try {
      let pool = await sql.connect(config);
      let lista = await pool.request().query("DECLARE @Usuario_que_dieron_alta_clientes TABLE(AUDI_FECHA datetime, AUCL_CLIENTE int, CLIE_NOMBRE varchar(30), AUDI_USUARIO varchar(8), USUA_NOMBRE varchar(30), AUDI_INSERTA decimal(1,0)) INSERT INTO @Usuario_que_dieron_alta_clientes SELECT dbo.SEGU_AUDI.AUDI_FECHA ,dbo.CCOB_AUCL.AUCL_CLIENTE ,dbo.CCOB_CLIE.CLIE_NOMBRE ,dbo.SEGU_AUDI.AUDI_USUARIO ,dbo.SEGU_USUA.USUA_NOMBRE ,dbo.SEGU_AUDI.AUDI_INSERTA FROM ((dbo.SEGU_AUDI WITH (NOLOCK) INNER JOIN dbo.CCOB_AUCL WITH (NOLOCK) ON dbo.SEGU_AUDI.AUDI_AUDITOR = dbo.CCOB_AUCL.AUCL_AUDITOR) INNER JOIN dbo.SEGU_USUA WITH (NOLOCK) ON dbo.SEGU_AUDI.AUDI_USUARIO = dbo.SEGU_USUA.USUA_USUARIO) INNER JOIN dbo.CCOB_CLIE WITH (NOLOCK) ON dbo.CCOB_AUCL.AUCL_CLIENTE = dbo.CCOB_CLIE.CLIE_CLIENTE WHERE (((dbo.SEGU_AUDI.AUDI_INSERTA)=1)) SELECT FORMAT(CAST(dbo.CCOB_CLIE.CLIE_FECHA_ALTA as DATE), 'yyyy-MM-dd') AS [Fecha_alta_cliente] ,dbo.CCOB_CLIE.CLIE_CLIENTE AS [Nro_cliente] ,dbo.CCOB_CLIE.CLIE_NOMBRE AS [Nombre_cliente] ,dbo.CCOB_DCLI.DCLI_RENGLON AS [Cod_domic] ,CASE WHEN dbo.CCOB_DCLI.DCLI_FAX IS NULL THEN '' ELSE dbo.CCOB_DCLI.DCLI_FAX END AS [Fax_celular] ,IIf(ISNULL(CASE WHEN dbo.CCOB_DCLI.DCLI_FAX IS NULL THEN '' ELSE dbo.CCOB_DCLI.DCLI_FAX END,0)='','',IIF(Len(DCLI_FAX)=10,'','Completar, revisar «Fax (celular)»')) AS Verificacion ,dbo.CCOB_DCLI.DCLI_TELEFONO AS Telefono ,dbo.CCOB_DCLI.DCLI_OBSERVACION AS [Observ_domicilio] ,dbo.CCOB_CLIE.CLIE_COBRADOR AS Cobrador ,dbo.SIST_VEND.VEND_NOMBRE AS Vendedor ,[@Usuario_que_dieron_alta_clientes].AUDI_USUARIO AS [Auditoria] ,[@Usuario_que_dieron_alta_clientes].USUA_NOMBRE AS [Nombre_Usuario] FROM ((dbo.CCOB_CLIE WITH (NOLOCK) INNER JOIN dbo.CCOB_DCLI WITH (NOLOCK) ON dbo.CCOB_CLIE.CLIE_CLIENTE = dbo.CCOB_DCLI.DCLI_CLIENTE) INNER JOIN (dbo.CCOB_VECL WITH (NOLOCK) INNER JOIN dbo.SIST_VEND WITH (NOLOCK) ON dbo.CCOB_VECL.VECL_VENDEDOR = dbo.SIST_VEND.VEND_VENDEDOR) ON dbo.CCOB_CLIE.CLIE_CLIENTE = dbo.CCOB_VECL.VECL_CLIENTE) INNER JOIN @Usuario_que_dieron_alta_clientes ON dbo.CCOB_VECL.VECL_CLIENTE = [@Usuario_que_dieron_alta_clientes].AUCL_CLIENTE");
      return lista.recordsets;
    }
    catch (error) {
      console.log(error);
    }
  }

  async function getOrder(fechaAlta) {
    try {
      let  pool = await  sql.connect(config);
      let  product = await  pool.request()
      .input('input_parameter', sql.Date, fechaAlta)
      .query("SELECT FORMAT(CAST(dbo.CCOB_CLIE.CLIE_FECHA_ALTA as DATE), 'dd-MM-yyyy') AS [CLIE_FECHA_ALTA] ,dbo.SEGU_AUDI.AUDI_USUARIO ,dbo.SEGU_USUA.USUA_NOMBRE ,dbo.CCOB_VECL.VECL_VENDEDOR ,dbo.SIST_VEND.VEND_NOMBRE ,dbo.CCOB_CLIE.CLIE_CLIENTE ,dbo.CCOB_CLIE.CLIE_NOMBRE ,dbo.CCOB_CLIE.CLIE_EMAIL ,dbo.CCOB_CLC5.CLC5_CLASIF_5 ,dbo.CCOB_DCLI.DCLI_DOMICILIO ,dbo.CCOB_DCLI.DCLI_LOCALIDAD ,dbo.CCOB_DCLI.DCLI_COD_LOCALIDAD ,dbo.CCOB_DCLI.DCLI_MUNICIPIO ,dbo.CCOB_DCLI.DCLI_COD_POSTAL ,dbo.CCOB_DCLI.DCLI_PROVINCIA ,dbo.CCOB_CLIE.CLIE_CONDICION_IVA ,dbo.CCOB_CLIE.CLIE_CUIT FROM ((dbo.SEGU_AUDI INNER JOIN ((((dbo.CCOB_CLIE INNER JOIN dbo.CCOB_DCLI ON dbo.CCOB_CLIE.CLIE_CLIENTE = dbo.CCOB_DCLI.DCLI_CLIENTE) INNER JOIN dbo.CCOB_CLPF ON dbo.CCOB_CLIE.CLIE_CLIENTE = dbo.CCOB_CLPF.CLPF_CLIENTE) INNER JOIN dbo.CCOB_CLC5 ON dbo.CCOB_CLIE.CLIE_CLASIF_5 = dbo.CCOB_CLC5.CLC5_CLASIF_5) INNER JOIN dbo.CCOB_AUCL ON dbo.CCOB_CLIE.CLIE_CLIENTE = dbo.CCOB_AUCL.AUCL_CLIENTE) ON dbo.SEGU_AUDI.AUDI_AUDITOR = dbo.CCOB_AUCL.AUCL_AUDITOR) INNER JOIN dbo.SEGU_USUA ON dbo.SEGU_AUDI.AUDI_USUARIO = dbo.SEGU_USUA.USUA_USUARIO) INNER JOIN (dbo.CCOB_VECL INNER JOIN dbo.SIST_VEND ON dbo.CCOB_VECL.VECL_VENDEDOR = dbo.SIST_VEND.VEND_VENDEDOR) ON dbo.CCOB_CLIE.CLIE_CLIENTE = dbo.CCOB_VECL.VECL_CLIENTE WHERE (((dbo.SEGU_AUDI.AUDI_INSERTA)=1)) AND CAST(dbo.CCOB_CLIE.CLIE_FECHA_ALTA as DATE) >= FORMAT(CAST(@input_parameter as date), 'dd-MM-yyyy')");
      return  product.recordsets;
    }
    catch (error) {
      console.log(error);
    }
  }

  async function addControl(control) {
    try {
      let  pool = await  sql.connect(config);
      let  insertControl = await  pool.request()
      .input('CLIE_FECHA_ALTA', sql.Date(), control.CLIE_FECHA_ALTA)
      .input('AUDI_USUARIO', sql.VarChar(8), control.AUDI_USUARIO)
      .input('USUA_NOMBRE', sql.VarChar(30), control.USUA_NOMBRE)
      .input('VEND_NOMBRE', sql.VarChar(30), control.VEND_NOMBRE)
      .input('CLIE_CLIENTE', sql.VarChar(30), control.CLIE_CLIE)
      .input('CLIE_NOMBRE', sql.VarChar(30), control.CLIE_NOMBRE)
      .input('CLIE_EMAIL', sql.VarChar(250), control.CLIE_EMAIL)
      .input('CLC5_CLASIF_5', sql.VarChar(4), control.CLC5_NOMBRE)
      .input('DCLI_DOMICILIO', sql.VarChar(60), control.DCLI_DOMICILIO)
      .input('DCLI_LOCALIDAD', sql.VarChar(50), control.DCLI_LOCALIDAD)
      .input('DCLI_COD_LOCALIDAD', sql.VarChar(5), control.DCLI_COD_LOCALIDAD)
      .input('DCLI_COD_POSTAL', sql.VarChar(10), control.DCLI_COD_POSTAL)
      .input('DCLI_PROVINCIA', sql.VarChar(3), control.DCLI_PROVINCIA)
      .input('CLIE_CONDICION_IVA', sql.VarChar(4), control.CLIE_CONDICION_IVA)
      .input('CLIE_CUIT ', sql.VarChar(15), control.CLIE_CUIT )
      .execute('InsertControl');
      return  insertControl.recordsets;
    }
    catch (err) {
      console.log(err);
    }
  }

  module.exports = {
    getControl: getControl,
    getOrder: getOrder,
    addControl: addControl,
    getListaClientes: getListaClientes,
    getNPpendienteEntregaContenedores: getNPpendienteEntregaContenedores,
    getListaContenedores: getListaContenedores,
    getLPPYRStock: getLPPYRStock
  }